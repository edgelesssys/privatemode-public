apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: secret-service
  namespace: continuum-992a45
  labels:
    app.kubernetes.io/instance: '992a45'
spec:
  replicas: 3
  serviceName: secret-service-headless
  selector:
    matchLabels:
      app: secret-service
  template:
    metadata:
      labels:
        app: secret-service
        app.kubernetes.io/instance: '992a45'
    spec:
      runtimeClassName: contrast-cc
      containers:
        - name: secret-service
          image: 'ghcr.io/edgelesssys/privatemode/secret-service:v1.29.0@sha256:cd977d9c74e8ca76469b97fd21a0ffdc6bac20eee38bca2f510af09cede1e897'
          command: ["/bin/sh", "-c"]
          args:
            - |
              exec /bin/secret-service \
                --k8s-namespace=continuum-992a45 \
                $([ "${HOSTNAME##*-}" = "0" ] && echo "--may-bootstrap") \
                --etcd-server-cert=/contrast/tls-config/certChain.pem \
                --etcd-server-key=/contrast/tls-config/key.pem \
                --etcd-ca=/contrast/tls-config/mesh-ca.pem
          ports:
            - containerPort: 3000
            - containerPort: 3001
            - containerPort: 9000
            - containerPort: 2379
            - containerPort: 2380
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workload-gptoss
  namespace: continuum-992a45
  labels:
    app: workload-gptoss
    app.kubernetes.io/instance: '992a45'
spec:
  replicas: 1
  selector:
    matchLabels:
      app: workload-gptoss
  template:
    metadata:
      labels:
        app: workload-gptoss
        app.kubernetes.io/instance: '992a45'
        privatemode.edgeless.systems/needs-gpu: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/scheme: "http"
    spec:
      serviceAccountName: workload-gptoss-sa
      runtimeClassName: contrast-cc
      initContainers:
        - name: attestation-agent
          volumeMounts:
            - name: privatemode-ca-cert
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
            - mountPath: /contrast
              name: contrast-secrets
          image: ghcr.io/edgelesssys/privatemode/attestation-agent:v1.29.0@sha256:42238d276d4499ad33c9a882fccd82e4f7b37d299c619e9301ba51a252861fbc
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
          command:
            - '/bin/sh'
            - '-c'
          args:
            - |
              LD_PRELOAD=/usr/lib64/libcuda.so.1:/usr/lib64/libnvidia-ml.so.1 attestation-agent \
                --gpu-driver-versions=570.172.08 \
                --gpu-vbios-versions=96.00.88.00.11,96.00.74.00.11,96.00.9F.00.04,96.00.74.00.1C
          securityContext:
            privileged: true
          resources:
            limits:
              "nvidia.com/GH100_H100_PCIE": 1
        - name: disk-mounter-gptoss-0
          image: ghcr.io/edgelesssys/privatemode/disk-mounter:v1.29.0@sha256:0a6fc65f50b2eafcc0521014487c4ead6fd9dc3f867dfba3622827bbdec8c144
          command:
            - /bin/sh
            - -ec
            - |
              blockdev --setra 16384 /dev/modelweights-gptoss-0
              exec /bin/disk-mounter "$@"
            - _
          args:
            - --root-hash=682ea81fb02151c70b8c281159559b14b9bc4b0368ad4fbb50203f556ad3ddc3
            - --device-path=/dev/modelweights-gptoss-0
            - --mount-path=/mnt/modelweights-gptoss-0
          restartPolicy: Always
          securityContext:
            privileged: true
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: Bidirectional
          volumeDevices:
            - name: modelweights-gptoss-0
              devicePath: /dev/modelweights-gptoss-0
      containers:
        - name: workload-gptoss-0
          image: docker.io/vllm/vllm-openai:v0.11.0@sha256:014a95f21c9edf6abe0aea6b07353f96baa4ec291c427bb1176dc7c93a85845c
          ports:
            - containerPort: 8000
          readinessProbe:
            httpGet:
              path: /v1/models
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: LD_PRELOAD
              value: "/usr/lib/x86_64-linux-gnu/libcuda.so.1"
            - name: LD_LIBRARY_PATH
              value: "/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu"
          command:
            - /bin/sh
            - -ec
            - |
              cp /untrusted-gptoss/gpt-oss-tools.patch /vllm-workspace/gpt-oss-tools.patch
              cp /untrusted-gptoss/openai-tool-parser.patch /vllm-workspace/openai-tool-parser.patch
              if [ $(sha256sum /vllm-workspace/gpt-oss-tools.patch | cut -d ' ' -f 1) != '60c392f587b6dc0d97cbee343460c4d4be0a15a297b60420c92248a3a365c16a' ]; then echo patch file hash mismatch: $(sha256sum /vllm-workspace/gpt-oss-tools.patch | cut -d ' ' -f 1); exit 1; fi
              if [ $(sha256sum /vllm-workspace/openai-tool-parser.patch | cut -d ' ' -f 1) != '8dc4e52544b9f3fd8adbd366be908eaa7fce9899e96c417c40c56a6eba6190f4' ]; then echo patch file hash mismatch: $(sha256sum /vllm-workspace/openai-tool-parser.patch | cut -d ' ' -f 1); exit 1; fi
              patch --batch --fuzz=0 /usr/local/lib/python3.12/dist-packages/vllm/entrypoints/openai/serving_chat.py < /vllm-workspace/gpt-oss-tools.patch
              patch --batch --fuzz=0 /usr/local/lib/python3.12/dist-packages/vllm/entrypoints/openai/tool_parsers/openai_tool_parser.py < /vllm-workspace/openai-tool-parser.patch
              exec python3 -m vllm.entrypoints.openai.api_server "$@"
            - _
          args:
            - '--host=0.0.0.0'
            - '--port=8000'
            - '--model=/mnt/modelweights-gptoss-0'
            - '--enable-prompt-tokens-details'
            - '--gpu-memory-utilization=0.92'
            - '--max-num-seqs=256'
            - '--enable-auto-tool-choice'
            - '--tool-call-parser'
            - 'openai'
            - '--reasoning-parser'
            - 'openai_gptoss'
            - '--structured-outputs-config={"backend": "xgrammar", "disable_any_whitespace": true}'
            - '--prefix-caching-hash-algo=sha256'
            - '--served-model-name'
            - 'openai/gpt-oss-120b'
            - 'gpt-oss-120b'
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: HostToContainer
            - name: vllm-gpt-oss-tools-patch
              mountPath: /untrusted-gptoss
              readOnly: true
          resources:
            requests:
              memory: 64Gi
            limits:
              memory: 64Gi
              "nvidia.com/GH100_H100_PCIE": 1
        - name: inference-proxy-gptoss-0
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8085
            - containerPort: 8185
          args:
            - '--adapter-type=openai'
            - '--workload-address=127.0.0.1'
            - '--listen-port=8085'
            - '--metrics-port=8185'
            - '--workload-port=8000'
            - '--secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local'
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
            - '--workload-tasks=generate,tool_calling'
          volumeMounts:
            - name: inference-proxy-gptoss-0-tls-cert
              mountPath: /etc/tls
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: workload-gptoss
      volumes:
        - name: privatemode-ca-cert
          secret:
            secretName: privatemode-ca-secret
            items:
              - key: ca.crt
                path: ca.crt
        - emptyDir: {}
          name: mount-dir
        - emptyDir: {}
          name: continuum-run
        - name: vllm-gpt-oss-tools-patch
          configMap:
            name: vllm-gpt-oss-tools-patch
        - name: inference-proxy-gptoss-0-tls-cert
          secret:
            secretName: inference-proxy-gptoss-0-tls-secret
        - name: modelweights-gptoss-0
          ephemeral:
            volumeClaimTemplate:
              metadata: {}
              spec:
                storageClassName: openai-gpt-oss-120b-reproducible
                volumeMode: Block
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 67Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workload-multimodal-qwenembed
  namespace: continuum-992a45
  labels:
    app: workload-multimodal-qwenembed
    app.kubernetes.io/instance: '992a45'
spec:
  replicas: 1
  selector:
    matchLabels:
      app: workload-multimodal-qwenembed
  template:
    metadata:
      labels:
        app: workload-multimodal-qwenembed
        app.kubernetes.io/instance: '992a45'
        privatemode.edgeless.systems/needs-gpu: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/scheme: "http"
    spec:
      serviceAccountName: workload-multimodal-qwenembed-sa
      runtimeClassName: contrast-cc
      initContainers:
        - name: attestation-agent
          volumeMounts:
            - name: privatemode-ca-cert
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
            - mountPath: /contrast
              name: contrast-secrets
          image: ghcr.io/edgelesssys/privatemode/attestation-agent:v1.29.0@sha256:42238d276d4499ad33c9a882fccd82e4f7b37d299c619e9301ba51a252861fbc
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
          command:
            - '/bin/sh'
            - '-c'
          args:
            - |
              LD_PRELOAD=/usr/lib64/libcuda.so.1:/usr/lib64/libnvidia-ml.so.1 attestation-agent \
                --gpu-driver-versions=570.172.08 \
                --gpu-vbios-versions=96.00.88.00.11,96.00.74.00.11,96.00.9F.00.04,96.00.74.00.1C
          securityContext:
            privileged: true
          resources:
            limits:
              "nvidia.com/GH100_H100_PCIE": 1
        - name: disk-mounter-multimodal-0
          image: ghcr.io/edgelesssys/privatemode/disk-mounter:v1.29.0@sha256:0a6fc65f50b2eafcc0521014487c4ead6fd9dc3f867dfba3622827bbdec8c144
          command:
            - /bin/sh
            - -ec
            - |
              blockdev --setra 16384 /dev/modelweights-multimodal-0
              exec /bin/disk-mounter "$@"
            - _
          args:
            - --root-hash=d7257b7f4d1b0d610fdbe7504f9d2a86f9c3c219917f2b77bb3d05f0b25f317a
            - --device-path=/dev/modelweights-multimodal-0
            - --mount-path=/mnt/modelweights-multimodal-0
          restartPolicy: Always
          securityContext:
            privileged: true
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: Bidirectional
          volumeDevices:
            - name: modelweights-multimodal-0
              devicePath: /dev/modelweights-multimodal-0
        - name: disk-mounter-qwenembed-1
          image: ghcr.io/edgelesssys/privatemode/disk-mounter:v1.29.0@sha256:0a6fc65f50b2eafcc0521014487c4ead6fd9dc3f867dfba3622827bbdec8c144
          command:
            - /bin/sh
            - -ec
            - |
              blockdev --setra 16384 /dev/modelweights-qwenembed-1
              exec /bin/disk-mounter "$@"
            - _
          args:
            - --root-hash=a0bd28202038517c620a138d35309c53e7fad50ec634e85a27060906e65e628f
            - --device-path=/dev/modelweights-qwenembed-1
            - --mount-path=/mnt/modelweights-qwenembed-1
          restartPolicy: Always
          securityContext:
            privileged: true
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: Bidirectional
          volumeDevices:
            - name: modelweights-qwenembed-1
              devicePath: /dev/modelweights-qwenembed-1
      containers:
        - name: workload-multimodal-0
          image: docker.io/vllm/vllm-openai:v0.11.0@sha256:014a95f21c9edf6abe0aea6b07353f96baa4ec291c427bb1176dc7c93a85845c
          ports:
            - containerPort: 8000
          readinessProbe:
            httpGet:
              path: /v1/models
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: LD_PRELOAD
              value: "/usr/lib/x86_64-linux-gnu/libcuda.so.1"
            - name: LD_LIBRARY_PATH
              value: "/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu"
          args:
            - '--host=0.0.0.0'
            - '--port=8000'
            - '--model=/mnt/modelweights-multimodal-0'
            - '--enable-prompt-tokens-details'
            - '--gpu-memory-utilization=0.85'
            - '--max-num-seqs=256'
            - --mm-processor-kwargs
            - '{"do_pan_and_scan": true}'
            - '--structured-outputs-config={"backend": "xgrammar", "disable_any_whitespace": true}'
            - '--prefix-caching-hash-algo=sha256'
            - '--served-model-name'
            - 'leon-se/gemma-3-27b-it-fp8-dynamic'
            - 'gemma-3-27b'
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: HostToContainer
          resources:
            requests:
              memory: 64Gi
            limits:
              memory: 64Gi
              "nvidia.com/GH100_H100_PCIE": 1
        - name: inference-proxy-multimodal-0
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8085
            - containerPort: 8185
          args:
            - '--adapter-type=openai'
            - '--workload-address=127.0.0.1'
            - '--listen-port=8085'
            - '--metrics-port=8185'
            - '--workload-port=8000'
            - '--secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local'
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
            - '--workload-tasks=generate,vision'
          volumeMounts:
            - name: inference-proxy-multimodal-0-tls-cert
              mountPath: /etc/tls
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
        - name: workload-qwenembed-1
          image: docker.io/vllm/vllm-openai:v0.11.0@sha256:014a95f21c9edf6abe0aea6b07353f96baa4ec291c427bb1176dc7c93a85845c
          ports:
            - containerPort: 8001
          readinessProbe:
            httpGet:
              path: /v1/models
              port: 8001
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: LD_PRELOAD
              value: "/usr/lib/x86_64-linux-gnu/libcuda.so.1"
            - name: LD_LIBRARY_PATH
              value: "/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu"
          args:
            - '--host=0.0.0.0'
            - '--port=8001'
            - '--model=/mnt/modelweights-qwenembed-1'
            - '--enable-prompt-tokens-details'
            - '--task=embed'
            - '--gpu-memory-utilization=0.12'
            - '--max-num-seqs=256'
            - '--no-enable-prefix-caching'
            - '--served-model-name'
            - 'qwen3-embedding-4b'
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: HostToContainer
          resources:
            requests:
              memory: 64Gi
            limits:
              memory: 64Gi
        - name: inference-proxy-qwenembed-1
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8086
            - containerPort: 8186
          args:
            - '--adapter-type=openai'
            - '--workload-address=127.0.0.1'
            - '--listen-port=8086'
            - '--metrics-port=8186'
            - '--workload-port=8001'
            - '--secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local'
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
            - '--workload-tasks=embed'
          volumeMounts:
            - name: inference-proxy-qwenembed-1-tls-cert
              mountPath: /etc/tls
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: workload-multimodal-qwenembed
      volumes:
        - name: privatemode-ca-cert
          secret:
            secretName: privatemode-ca-secret
            items:
              - key: ca.crt
                path: ca.crt
        - emptyDir: {}
          name: mount-dir
        - emptyDir: {}
          name: continuum-run
        - name: inference-proxy-multimodal-0-tls-cert
          secret:
            secretName: inference-proxy-multimodal-0-tls-secret
        - name: inference-proxy-qwenembed-1-tls-cert
          secret:
            secretName: inference-proxy-qwenembed-1-tls-secret
        - name: modelweights-multimodal-0
          ephemeral:
            volumeClaimTemplate:
              metadata: {}
              spec:
                storageClassName: leon-se-gemma-3-27b-it-fp8-dynamic-reproducible
                volumeMode: Block
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 30Gi
        - name: modelweights-qwenembed-1
          ephemeral:
            volumeClaimTemplate:
              metadata: {}
              spec:
                storageClassName: boboliu-qwen3-embedding-4b-w4a16-g128
                volumeMode: Block
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 3Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workload-textgen-embeddings
  namespace: continuum-992a45
  labels:
    app: workload-textgen-embeddings
    app.kubernetes.io/instance: '992a45'
spec:
  replicas: 1
  selector:
    matchLabels:
      app: workload-textgen-embeddings
  template:
    metadata:
      labels:
        app: workload-textgen-embeddings
        app.kubernetes.io/instance: '992a45'
        privatemode.edgeless.systems/needs-gpu: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/scheme: "http"
    spec:
      serviceAccountName: workload-textgen-embeddings-sa
      runtimeClassName: contrast-cc
      initContainers:
        - name: attestation-agent
          volumeMounts:
            - name: privatemode-ca-cert
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
            - mountPath: /contrast
              name: contrast-secrets
          image: ghcr.io/edgelesssys/privatemode/attestation-agent:v1.29.0@sha256:42238d276d4499ad33c9a882fccd82e4f7b37d299c619e9301ba51a252861fbc
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
          command:
            - '/bin/sh'
            - '-c'
          args:
            - |
              LD_PRELOAD=/usr/lib64/libcuda.so.1:/usr/lib64/libnvidia-ml.so.1 attestation-agent \
                --gpu-driver-versions=570.172.08 \
                --gpu-vbios-versions=96.00.88.00.11,96.00.74.00.11,96.00.9F.00.04,96.00.74.00.1C
          securityContext:
            privileged: true
          resources:
            limits:
              "nvidia.com/GH100_H100_PCIE": 1
        - name: disk-mounter-textgen-0
          image: ghcr.io/edgelesssys/privatemode/disk-mounter:v1.29.0@sha256:0a6fc65f50b2eafcc0521014487c4ead6fd9dc3f867dfba3622827bbdec8c144
          command:
            - /bin/sh
            - -ec
            - |
              blockdev --setra 16384 /dev/modelweights-textgen-0
              exec /bin/disk-mounter "$@"
            - _
          args:
            - --root-hash=165d32d245afcaf41419285611f0537a687b6f17efc3dc79bea52d1ba4a28e38
            - --device-path=/dev/modelweights-textgen-0
            - --mount-path=/mnt/modelweights-textgen-0
          restartPolicy: Always
          securityContext:
            privileged: true
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: Bidirectional
          volumeDevices:
            - name: modelweights-textgen-0
              devicePath: /dev/modelweights-textgen-0
        - name: disk-mounter-embeddings-1
          image: ghcr.io/edgelesssys/privatemode/disk-mounter:v1.29.0@sha256:0a6fc65f50b2eafcc0521014487c4ead6fd9dc3f867dfba3622827bbdec8c144
          command:
            - /bin/sh
            - -ec
            - |
              blockdev --setra 16384 /dev/modelweights-embeddings-1
              exec /bin/disk-mounter "$@"
            - _
          args:
            - --root-hash=43528ec4f7e2d9a2dfd137844fdd7db56d29c8bbf314b533c279fa5962d09d2f
            - --device-path=/dev/modelweights-embeddings-1
            - --mount-path=/mnt/modelweights-embeddings-1
          restartPolicy: Always
          securityContext:
            privileged: true
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: Bidirectional
          volumeDevices:
            - name: modelweights-embeddings-1
              devicePath: /dev/modelweights-embeddings-1
      containers:
        - name: workload-textgen-0
          image: docker.io/vllm/vllm-openai:v0.11.0@sha256:014a95f21c9edf6abe0aea6b07353f96baa4ec291c427bb1176dc7c93a85845c
          ports:
            - containerPort: 8000
          readinessProbe:
            httpGet:
              path: /v1/models
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: LD_PRELOAD
              value: "/usr/lib/x86_64-linux-gnu/libcuda.so.1"
            - name: LD_LIBRARY_PATH
              value: "/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu"
          args:
            - '--host=0.0.0.0'
            - '--port=8000'
            - '--model=/mnt/modelweights-textgen-0'
            - '--enable-prompt-tokens-details'
            - '--gpu-memory-utilization=0.86'
            - '--max-num-seqs=256'
            - '--max-model-len=70000'
            - '--enable-auto-tool-choice'
            - '--tool-call-parser'
            - 'llama3_json'
            - '--structured-outputs-config={"backend": "xgrammar", "disable_any_whitespace": true}'
            - '--prefix-caching-hash-algo=sha256'
            - '--served-model-name'
            - 'ibnzterrell/Meta-Llama-3.3-70B-Instruct-AWQ-INT4'
            - 'llama-3.3-70b'
            - 'latest'
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: HostToContainer
          resources:
            requests:
              memory: 64Gi
            limits:
              memory: 64Gi
              "nvidia.com/GH100_H100_PCIE": 1
        - name: inference-proxy-textgen-0
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8085
            - containerPort: 8185
          args:
            - '--adapter-type=openai'
            - '--workload-address=127.0.0.1'
            - '--listen-port=8085'
            - '--metrics-port=8185'
            - '--workload-port=8000'
            - '--secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local'
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
            - '--workload-tasks=generate,tool_calling'
          volumeMounts:
            - name: inference-proxy-textgen-0-tls-cert
              mountPath: /etc/tls
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
        - name: workload-embeddings-1
          image: docker.io/vllm/vllm-openai:v0.10.1.1@sha256:d731ee65c044ae0977421eed3d93f931d4b7d79614394184c939db35b8f28fc2
          ports:
            - containerPort: 8001
          readinessProbe:
            httpGet:
              path: /v1/models
              port: 8001
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: LD_PRELOAD
              value: "/usr/lib/x86_64-linux-gnu/libcuda.so.1"
            - name: LD_LIBRARY_PATH
              value: "/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu"
          args:
            - '--host=0.0.0.0'
            - '--port=8001'
            - '--model=/mnt/modelweights-embeddings-1'
            - '--enable-prompt-tokens-details'
            - '--gpu-memory-utilization=0.1'
            - '--max-num-seqs=256'
            - '--no-enable-prefix-caching'
            - '--served-model-name'
            - 'intfloat/multilingual-e5-large-instruct'
            - 'multilingual-e5-large'
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: HostToContainer
          resources:
            requests:
              memory: 64Gi
            limits:
              memory: 64Gi
        - name: inference-proxy-embeddings-1
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8086
            - containerPort: 8186
          args:
            - '--adapter-type=openai'
            - '--workload-address=127.0.0.1'
            - '--listen-port=8086'
            - '--metrics-port=8186'
            - '--workload-port=8001'
            - '--secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local'
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
            - '--workload-tasks=embed'
          volumeMounts:
            - name: inference-proxy-embeddings-1-tls-cert
              mountPath: /etc/tls
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: workload-textgen-embeddings
      volumes:
        - name: privatemode-ca-cert
          secret:
            secretName: privatemode-ca-secret
            items:
              - key: ca.crt
                path: ca.crt
        - emptyDir: {}
          name: mount-dir
        - emptyDir: {}
          name: continuum-run
        - name: inference-proxy-textgen-0-tls-cert
          secret:
            secretName: inference-proxy-textgen-0-tls-secret
        - name: inference-proxy-embeddings-1-tls-cert
          secret:
            secretName: inference-proxy-embeddings-1-tls-secret
        - name: modelweights-textgen-0
          ephemeral:
            volumeClaimTemplate:
              metadata: {}
              spec:
                storageClassName: ibnzterrell-meta-llama-3-3-70b-instruct-awq-int4-reproducible
                volumeMode: Block
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 41Gi
        - name: modelweights-embeddings-1
          ephemeral:
            volumeClaimTemplate:
              metadata: {}
              spec:
                storageClassName: intfloat-multilingual-e5-large-instruct-reproducible
                volumeMode: Block
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 2Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workload-transcriptions-codegen
  namespace: continuum-992a45
  labels:
    app: workload-transcriptions-codegen
    app.kubernetes.io/instance: '992a45'
spec:
  replicas: 1
  selector:
    matchLabels:
      app: workload-transcriptions-codegen
  template:
    metadata:
      labels:
        app: workload-transcriptions-codegen
        app.kubernetes.io/instance: '992a45'
        privatemode.edgeless.systems/needs-gpu: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/scheme: "http"
    spec:
      serviceAccountName: workload-transcriptions-codegen-sa
      runtimeClassName: contrast-cc
      initContainers:
        - name: attestation-agent
          volumeMounts:
            - name: privatemode-ca-cert
              mountPath: /etc/ssl/certs
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
            - mountPath: /contrast
              name: contrast-secrets
          image: ghcr.io/edgelesssys/privatemode/attestation-agent:v1.29.0@sha256:42238d276d4499ad33c9a882fccd82e4f7b37d299c619e9301ba51a252861fbc
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
          command:
            - '/bin/sh'
            - '-c'
          args:
            - |
              LD_PRELOAD=/usr/lib64/libcuda.so.1:/usr/lib64/libnvidia-ml.so.1 attestation-agent \
                --gpu-driver-versions=570.172.08 \
                --gpu-vbios-versions=96.00.88.00.11,96.00.74.00.11,96.00.9F.00.04,96.00.74.00.1C
          securityContext:
            privileged: true
          resources:
            limits:
              "nvidia.com/GH100_H100_PCIE": 1
        - name: disk-mounter-transcriptions-0
          image: ghcr.io/edgelesssys/privatemode/disk-mounter:v1.29.0@sha256:0a6fc65f50b2eafcc0521014487c4ead6fd9dc3f867dfba3622827bbdec8c144
          command:
            - /bin/sh
            - -ec
            - |
              blockdev --setra 16384 /dev/modelweights-transcriptions-0
              exec /bin/disk-mounter "$@"
            - _
          args:
            - --root-hash=d77fcd381dee672e89843bf782f571ea296833966beaf235f0c45f765473b782
            - --device-path=/dev/modelweights-transcriptions-0
            - --mount-path=/mnt/modelweights-transcriptions-0
          restartPolicy: Always
          securityContext:
            privileged: true
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: Bidirectional
          volumeDevices:
            - name: modelweights-transcriptions-0
              devicePath: /dev/modelweights-transcriptions-0
        - name: disk-mounter-codegen-1
          image: ghcr.io/edgelesssys/privatemode/disk-mounter:v1.29.0@sha256:0a6fc65f50b2eafcc0521014487c4ead6fd9dc3f867dfba3622827bbdec8c144
          command:
            - /bin/sh
            - -ec
            - |
              blockdev --setra 16384 /dev/modelweights-codegen-1
              exec /bin/disk-mounter "$@"
            - _
          args:
            - --root-hash=0605976b547cc008c4d202cbd97129715dc47ce526810c5334cf5620694d9d14
            - --device-path=/dev/modelweights-codegen-1
            - --mount-path=/mnt/modelweights-codegen-1
          restartPolicy: Always
          securityContext:
            privileged: true
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: Bidirectional
          volumeDevices:
            - name: modelweights-codegen-1
              devicePath: /dev/modelweights-codegen-1
      containers:
        - name: workload-transcriptions-0
          image: docker.io/vllm/vllm-openai:v0.10.1.1@sha256:d731ee65c044ae0977421eed3d93f931d4b7d79614394184c939db35b8f28fc2
          ports:
            - containerPort: 8000
          readinessProbe:
            httpGet:
              path: /v1/models
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: LD_PRELOAD
              value: "/usr/lib/x86_64-linux-gnu/libcuda.so.1"
            - name: LD_LIBRARY_PATH
              value: "/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu"
          command:
            - /bin/sh
            - -ec
            - |
              cp /untrusted-pylock/pylock.toml /vllm-workspace/pylock.toml
              if [ $(sha256sum /vllm-workspace/pylock.toml | cut -d ' ' -f 1) != 'a239e408d7319d4676a2b6ee33008ec5b83ad40ffdc67941c94f2d75f1d63da1' ]; then echo pylock.toml hash mismatch: $(sha256sum /vllm-workspace/pylock.toml | cut -d ' ' -f 1); exit 1; fi
              uv pip install -r /vllm-workspace/pylock.toml --system
              exec python3 -m vllm.entrypoints.openai.api_server "$@"
            - _
          args:
            - '--host=0.0.0.0'
            - '--port=8000'
            - '--model=/mnt/modelweights-transcriptions-0'
            - '--enable-prompt-tokens-details'
            - '--gpu-memory-utilization=0.4'
            - '--no-enable-prefix-caching'
            - '--served-model-name'
            - 'openai/whisper-large-v3'
            - 'whisper-large-v3'
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: HostToContainer
            - name: vllm-audio-pylock
              mountPath: /untrusted-pylock
              readOnly: true
          resources:
            requests:
              memory: 64Gi
            limits:
              memory: 64Gi
              "nvidia.com/GH100_H100_PCIE": 1
        - name: inference-proxy-transcriptions-0
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8085
            - containerPort: 8185
          args:
            - '--adapter-type=openai'
            - '--workload-address=127.0.0.1'
            - '--listen-port=8085'
            - '--metrics-port=8185'
            - '--workload-port=8000'
            - '--secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local'
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
            - '--workload-tasks=transcribe,translate'
          volumeMounts:
            - name: inference-proxy-transcriptions-0-tls-cert
              mountPath: /etc/tls
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
        - name: workload-codegen-1
          image: docker.io/vllm/vllm-openai:v0.11.0@sha256:014a95f21c9edf6abe0aea6b07353f96baa4ec291c427bb1176dc7c93a85845c
          ports:
            - containerPort: 8001
          readinessProbe:
            httpGet:
              path: /v1/models
              port: 8001
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: LD_PRELOAD
              value: "/usr/lib/x86_64-linux-gnu/libcuda.so.1"
            - name: LD_LIBRARY_PATH
              value: "/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu"
          args:
            - '--host=0.0.0.0'
            - '--port=8001'
            - '--model=/mnt/modelweights-codegen-1'
            - '--enable-prompt-tokens-details'
            - '--gpu-memory-utilization=0.55'
            - '--max-num-seqs=256'
            - '--max-model-len=131072'
            - '--enable-auto-tool-choice'
            - '--tool-call-parser'
            - 'qwen3_coder'
            - '--structured-outputs-config={"backend": "xgrammar", "disable_any_whitespace": true}'
            - '--prefix-caching-hash-algo=sha256'
            - '--served-model-name'
            - 'qwen3-coder-30b-a3b'
          volumeMounts:
            - name: mount-dir
              mountPath: /mnt
              mountPropagation: HostToContainer
          resources:
            requests:
              memory: 64Gi
            limits:
              memory: 64Gi
        - name: inference-proxy-codegen-1
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8086
            - containerPort: 8186
          args:
            - '--adapter-type=openai'
            - '--workload-address=127.0.0.1'
            - '--listen-port=8086'
            - '--metrics-port=8186'
            - '--workload-port=8001'
            - '--secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local'
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
            - '--workload-tasks=generate,tool_calling'
          volumeMounts:
            - name: inference-proxy-codegen-1-tls-cert
              mountPath: /etc/tls
              readOnly: true
            - name: continuum-run
              mountPath: /var/run/continuum
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: workload-transcriptions-codegen
      volumes:
        - name: privatemode-ca-cert
          secret:
            secretName: privatemode-ca-secret
            items:
              - key: ca.crt
                path: ca.crt
        - emptyDir: {}
          name: mount-dir
        - emptyDir: {}
          name: continuum-run
        - name: vllm-audio-pylock
          configMap:
            name: vllm-audio-pylock
        - name: inference-proxy-transcriptions-0-tls-cert
          secret:
            secretName: inference-proxy-transcriptions-0-tls-secret
        - name: inference-proxy-codegen-1-tls-cert
          secret:
            secretName: inference-proxy-codegen-1-tls-secret
        - name: modelweights-transcriptions-0
          ephemeral:
            volumeClaimTemplate:
              metadata: {}
              spec:
                storageClassName: openai-whisper-large-v3-reproducible
                volumeMode: Block
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 10Gi
        - name: modelweights-codegen-1
          ephemeral:
            volumeClaimTemplate:
              metadata: {}
              spec:
                storageClassName: stelterlab-qwen3-coder-30b-a3b-instruct-awq
                volumeMode: Block
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 18Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: unstructured-api
  namespace: continuum-992a45
  labels:
    app: unstructured-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: unstructured-api
  template:
    metadata:
      labels:
        app: unstructured-api
        app.kubernetes.io/instance: '992a45'
    spec:
      runtimeClassName: contrast-cc
      containers:
        - name: unstructured-api
          image: 'quay.io/unstructured-io/unstructured-api:0.0.89@sha256:b2abf2f37acafcbefa62e74e508c3176c14929213ba5ae962d6bbe03234b15e5'
          command:
            - /bin/sh
            - -ec
            - |
              test -f logger_config.yaml
              cp /untrusted/logger_config.yaml .
              if [ $(sha256sum logger_config.yaml | cut -d ' ' -f 1) != '62b5acd1bff3662a27d27f4d263273447f596f2244bd35e92a450eb2247d79dd' ]; then
                echo "logger config hash mismatch: $(sha256sum logger_config.yaml | cut -d ' ' -f 1)"
                exit 1
              fi
              exec scripts/app-start.sh
          resources:
            requests:
              memory: "24Gi"
            limits:
              memory: "24Gi"
          volumeMounts:
            - name: unstructured-api-logging-config
              mountPath: /untrusted
              readOnly: true
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /healthcheck
              port: http
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
        - name: inference-proxy
          image: ghcr.io/edgelesssys/privatemode/inference-proxy:v1.29.0@sha256:5caf5c816552fb99e3bc3bf494cb24ec8bccb1000f06efce65fe1ea76411b879
          ports:
            - containerPort: 8085
          args:
            - --adapter-type=unstructured
            - --workload-address=127.0.0.1
            - --workload-port=8000
            - --secret-svc-address=secret-service-internal.continuum-992a45.svc.cluster.local
            - '--etcd-member-cert=/contrast/tls-config/certChain.pem'
            - '--etcd-member-key=/contrast/tls-config/key.pem'
            - '--etcd-ca=/contrast/tls-config/mesh-ca.pem'
          volumeMounts:
            - name: unstructured-api-tls-cert
              mountPath: /etc/tls
              readOnly: true
      volumes:
        - name: unstructured-api-tls-cert
          secret:
            secretName: unstructured-api-tls-secret
        - name: unstructured-api-logging-config
          configMap:
            name: unstructured-api-logging-config
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coordinator
  namespace: 'continuum-992a45'
  labels:
    app.kubernetes.io/instance: '992a45'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: coordinator
  namespace: 'continuum-992a45'
  labels:
    app.kubernetes.io/instance: '992a45'
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - create
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: coordinator
  namespace: 'continuum-992a45'
  labels:
    app.kubernetes.io/instance: '992a45'
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: coordinator
subjects:
  - kind: ServiceAccount
    name: coordinator
    namespace: "continuum-992a45"
---
apiVersion: v1
kind: Service
metadata:
  name: coordinator
  namespace: 'continuum-992a45'
  labels:
    app.kubernetes.io/instance: '992a45'
spec:
  ports:
    - name: userapi
      port: 1313
      targetPort: 1313
    - name: meshapi
      port: 7777
      targetPort: 7777
    - name: transitapi
      port: 8200
      targetPort: 8200
    - name: default-userapi
      port: 443
      targetPort: 1313
  publishNotReadyAddresses: true
  selector:
    app.kubernetes.io/name: coordinator
    app.kubernetes.io/instance: '992a45'
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: coordinator-ready
  namespace: 'continuum-992a45'
  labels:
    app.kubernetes.io/instance: '992a45'
spec:
  ports:
    - name: userapi
      port: 1313
      targetPort: 1313
    - name: meshapi
      port: 7777
      targetPort: 7777
    - name: transitapi
      port: 8200
      targetPort: 8200
    - name: default-userapi
      port: 443
      targetPort: 1313
  selector:
    app.kubernetes.io/name: coordinator
    app.kubernetes.io/instance: '992a45'
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: coordinator
  namespace: 'continuum-992a45'
  labels:
    app.kubernetes.io/instance: '992a45'
spec:
  persistentVolumeClaimRetentionPolicy:
    whenDeleted: Delete
    whenScaled: Delete
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: coordinator
  serviceName: coordinator
  template:
    metadata:
      annotations:
        contrast.edgeless.systems/pod-role: coordinator
      labels:
        app.kubernetes.io/name: coordinator
        app.kubernetes.io/instance: '992a45'
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    contrast.edgeless.systems/pod-role: coordinator
                topologyKey: kubernetes.io/hostname
              weight: 100
      containers:
        - image: ghcr.io/edgelesssys/contrast/coordinator:v1.13.0@sha256:65e7832acb46d952d5c96c824d6f370999b8f3d547b3c2c449e82d8dc4b4816c
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /probe/liveness
              port: 9102
            periodSeconds: 10
          name: coordinator
          ports:
            - containerPort: 1313
              name: userapi
            - containerPort: 7777
              name: meshapi
            - containerPort: 8200
              name: transitapi
          readinessProbe:
            httpGet:
              path: /probe/readiness
              port: 9102
            periodSeconds: 5
          resources:
            limits:
              memory: 50Mi
            requests:
              memory: 50Mi
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
          startupProbe:
            failureThreshold: 60
            httpGet:
              path: /probe/startup
              port: 9102
            initialDelaySeconds: 1
            periodSeconds: 1
          env:
            - name: CONTRAST_LOG_FORMAT
              value: json
      runtimeClassName: contrast-cc
      serviceAccountName: coordinator
